<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <!-- –°—Ç–∏–ª–∏ -->
  <style>
    :root{
      --rs-blue:#0033A0; --rs-blue-2:#0A47C6; --rs-bg:#F5F7FB; --rs-text:#101828;
      --rs-muted:#667085; --border:#E5E7EB; --ok:#2E7D32; --bad:#C62828; --warn:#ED6C02;
      --card:#fff; --accent:#00AEEF;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--rs-bg);color:var(--rs-text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{
      background:linear-gradient(90deg,var(--rs-blue) 0%, var(--rs-blue-2) 100%);
      color:#fff; padding:16px; position:sticky; top:0; z-index:50; box-shadow:0 2px 12px rgba(0,0,0,.12)
    }
    .wrap{max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:50%;background:#fff;display:grid;place-items:center;color:var(--rs-blue);font-weight:900}
    h1{font-size:20px;margin:0}
    main{padding:18px 16px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){ .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    .card h2{margin:0 0 10px 0;font-size:18px}
    .muted{color:var(--rs-muted)} .small{font-size:12px}
    .u-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--rs-blue);color:#fff}
    .btn.secondary{background:#fff;color:var(--rs-blue);border:1px solid var(--rs-blue)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type=file]{padding:10px;background:#fff;border:1px dashed var(--border);border-radius:12px;width:100%}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .tile{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}
    .tile h3{margin:0 0 6px 0;font-size:14px;color:var(--rs-muted)}
    .tile .v{font-size:22px;font-weight:800}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{position:sticky;top:0;background:#F2F6FF;border-bottom:2px solid var(--border)}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child, td:first-child{text-align:left}
    tfoot td{font-weight:800;background:#FAFAFC}
    .delta.pos{color:var(--ok)} .delta.neg{color:var(--bad)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#E8F5E9;color:var(--ok)} .warn{background:#FFF3E0;color:var(--warn)} .bad{background:#FFEBEE;color:var(--bad)}
    .fit{width:100%;overflow:auto}
    canvas{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    .footer-actions{display:flex;flex-wrap:wrap;gap:10px}
    .hr{height:1px;background:var(--border);margin:10px 0 16px 0}

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å + –ª–æ–≥ */
    .progress{display:flex;align-items:center;gap:12px}
    .bar{flex:1;background:#E9EFFD;border-radius:999px;height:10px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#69A1FF,#0033A0)}
    .status{min-width:250px;font-size:12px;color:#123}
    .log{background:#0E1116;color:#D6E2FF;border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:220px;overflow:auto;border:1px solid #1E2633}
    .log .err{color:#FFB4B4}
    .log .warn{color:#FFD28A}
    .sticky-controls{position:sticky;bottom:12px;z-index:40}
  </style>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" integrity="sha512-2eQe5oFT2a4qG3TOFz0vSFGf0Ypkd4pV7C19fP3ITftl8hy2pLAxBlK7kMmXw8D1c3JIgtH1oE0hIGyrK8oaxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
</head>
<body>
  <header>
    <div class="wrap u-row">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <div>
          <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</h1>
          <div class="small" id="report-dates">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á—ë—Ç—ã (—Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π)</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <section class="card">
      <h2>1) –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ (PDF)</h2>
      <p class="muted small">–ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>—Ç–µ–∫—É—â–∏–π</b> –∏ <b>–ø—Ä–µ–¥—ã–¥—É—â–∏–π</b> –æ—Ç—á—ë—Ç—ã (—Å—Ç—Ä–∞–Ω–∏—Ü—ã 2‚Äì4 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã). –í—Å—Ç—Ä–æ–µ–Ω—ã –ª–æ–≥, –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∞–≤—Ç–æ–ø–æ—á–∏–Ω–∫–∞ pdf.js –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –≤–æ—Ä–∫–µ—Ä–æ–º.</p>
      <div class="grid grid-2">
        <div>
          <label class="small">–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.08.2025)</label>
          <input type="file" id="fileCurrent" accept="application/pdf" />
        </div>
        <div>
          <label class="small">–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 08.08.2025)</label>
          <input type="file" id="filePrev" accept="application/pdf" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="progress">
        <div class="bar"><span id="bar"></span></div>
        <div class="status" id="status">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤‚Ä¶</div>
      </div>
      <div class="hr"></div>

      <div class="u-row sticky-controls">
        <button class="btn" id="btnParse" disabled>üîé –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        <span class="small muted" id="parseStatus"></span>
      </div>

      <div class="hr"></div>
      <div class="log" id="log"></div>
    </section>

    <!-- KPI -->
    <section class="card">
      <h2>2) –ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É</h2>
      <div class="kpi" id="kpi"></div>
      <p class="small muted">¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª = —Ä–∞–∑–Ω–∏—Ü–∞ ¬´–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç¬ª –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –æ—Ç—á—ë—Ç–∞–º–∏ (—Å—Ç—Ä. 2, —Å—Ç—Ä–æ–∫–∞ ¬´–û–±—â–∏–π –∏—Ç–æ–≥¬ª).</p>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 -->
    <section class="card">
      <h2>3) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –°—Ç–∞–¥–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º)</h2>
      <div id="p2Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p2Chart" height="120"></canvas>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 -->
    <section class="card">
      <h2>4) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425 (–ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º)</h2>
      <div id="p3Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p3Chart" height="120"></canvas>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 -->
    <section class="card">
      <h2>5) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª (–ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º)</h2>
      <div id="p4Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p4Chart" height="120"></canvas>
    </section>

    <!-- –í—ã–≥—Ä—É–∑–∫–∏ -->
    <section class="card">
      <h2>6) –í—ã–≥—Ä—É–∑–∫–∏</h2>
      <div class="footer-actions">
        <button class="btn" id="dlPptx">üìä –°–∫–∞—á–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é PPTX</button>
        <button class="btn secondary" id="dlPptPdf">üìä –°–∫–∞—á–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é PDF</button>
        <button class="btn" id="dlDocx">üìë –°–∫–∞—á–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É Word</button>
        <button class="btn secondary" id="dlDocPdf">üìë –°–∫–∞—á–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É PDF</button>
      </div>
    </section>
  </main>

<script>
/* ============================== –õ–û–ì–ò –∏ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –õ–û–í–£–®–ö–ò ============================== */
const $ = s => document.querySelector(s);
function log(msg, type="info"){
  const el = $("#log");
  const time = new Date().toLocaleTimeString('ru-RU');
  const line = document.createElement("div");
  if(type==="error") line.classList.add("err");
  if(type==="warn")  line.classList.add("warn");
  line.textContent = `[${time}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
  console[type==="error"?"error":type==="warn"?"warn":"log"](msg);
}
window.onerror = function(message, source, lineno, colno, error){
  log(`JS Error: ${message} at ${source}:${lineno}:${colno}`, "error");
};
window.onunhandledrejection = function(e){
  log(`Unhandled Promise Rejection: ${e.reason?.message || e.reason || e}`, "error");
};

/* ============================== –ü–†–û–ì–†–ï–°–° ============================== */
function setStatus(text){ $("#status").textContent = text; }
function setBar(p){ $("#bar").style.width = Math.max(0, Math.min(100, p)) + "%"; }

/* ============================== pdf.js ‚Äî worker + fallback ============================== */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js";

async function loadPdfWithFallback(file, label){
  const ab = await file.arrayBuffer();
  // 1) –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Å –≤–æ—Ä–∫–µ—Ä–æ–º
  try{
    setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${label}: worker‚Ä¶`); log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${label} (worker)`);
    const task = pdfjsLib.getDocument({ data: ab });
    const pdf = await task.promise;
    log(`${label}: –∑–∞–≥—Ä—É–∂–µ–Ω (worker)`);
    return { pdf, usedWorker:true };
  }catch(err1){
    log(`${label}: –æ—à–∏–±–∫–∞ worker (${err1 && err1.message || err1}). –ü—Ä–æ–±—É—é disableWorker‚Ä¶`, "warn");
    // 2) Fallback: –±–µ–∑ –≤–æ—Ä–∫–µ—Ä–∞
    try{
      const task2 = pdfjsLib.getDocument({ data: ab, disableWorker: true });
      const pdf2 = await task2.promise;
      log(`${label}: –∑–∞–≥—Ä—É–∂–µ–Ω (disableWorker)`);
      return { pdf: pdf2, usedWorker:false };
    }catch(err2){
      log(`${label}: –æ—à–∏–±–∫–∞ –∏ –±–µ–∑ worker (${err2 && err2.message || err2})`, "error");
      throw err2;
    }
  }
}

/* ============================== –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø ============================== */
const FILIALS = [
  "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
  "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°",
];
const CANON_STATUSES = [
  "–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
  "–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞",
  "–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ",
];
function normStr(s){
  if(!s) return "";
  return String(s)
    .replace(/\u00A0/g," ")     // NBSP
    .replace(/[‚Äê‚Äì‚Äî‚àí]/g,"-")     // –≤—Å–µ —Ç–∏—Ä–µ -> "-"
    .replace(/\s+/g," ")
    .trim();
}
function nfmt(v){ return (v==null || isNaN(v)) ? "‚Äî" : v.toLocaleString('ru-RU'); }
function deltaFmt(v){ if(v==null||isNaN(v))return "‚Äî"; const cls=v>0?"pos":v<0?"neg":""; const sign=v>0?"+":""; return `<span class="delta ${cls}">${sign}${v.toLocaleString('ru-RU')}</span>`; }
function toIntSmart(s){
  if(s==null) return null;
  const t = String(s).replace(/\u00A0/g," ").replace(/\s/g," ");
  const m = t.match(/-?\d[\d\s]*\d|\d/); // –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ
  if(!m) return null;
  return parseInt(m[0].replace(/\s+/g,""),10);
}
function safeXY(item){
  // pdf.js: transform [a,b,c,d,e,f] ‚Äî e=X, f=Y
  const tr = item && item.transform;
  const x = (tr && typeof tr[4]==="number") ? tr[4] : 0;
  const y = (tr && typeof tr[5]==="number") ? tr[5] : 0;
  return {x,y};
}

/* ============================== –¢–ï–ö–°–¢ –ü–û –°–¢–†–ê–ù–ò–¶–ï ============================== */
async function getLinesFromPage(pdf, pageNum){
  const page = await pdf.getPage(pageNum);
  const textContent = await page.getTextContent();
  const items = (textContent && textContent.items) ? textContent.items : [];

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ Y‚Üì, X‚Üë
  const sorted = items.slice().sort((a,b)=>{
    const A = safeXY(a), B = safeXY(b);
    if (Math.abs(B.y - A.y) > 0.1) return B.y - A.y; // —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
    return A.x - B.x;                                 // —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
  });

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–æ–∫–∞–º: –¥–æ–ø—É—Å–∫ –ø–æ Y
  const rows = [];
  const Y_TOL = 2; // px
  for(const it of sorted){
    const {x,y} = safeXY(it);
    const s = normStr(it.str);
    if(!s) continue;
    let row = rows.find(r => Math.abs(r.y - y) <= Y_TOL);
    if(!row){ row = { y, parts:[] }; rows.push(row); }
    row.parts.push({x, s});
  }
  // –°–∫–ª–µ–∏–≤–∞–µ–º —á–∞—Å—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ X, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
  const lines = rows.map(r=>{
    r.parts.sort((a,b)=>a.x-b.x);
    return normStr(r.parts.map(p=>p.s).join(" "));
  }).filter(Boolean);

  return lines;
}

/* ============================== –ü–ê–†–°–ò–ù–ì –°–¢–†–£–ö–¢–£–†–´ ============================== */
function ensureTotalsIfMissing(parsed){
  // totals –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º –∫–∞–∫ —Å—É–º–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —è–≤–Ω–æ
  for(const [k,v] of Object.entries(parsed.filials||{})){
    if(v.total==null){
      const s = Object.values(v.statuses||{}).reduce((a,b)=>a+(+b||0),0);
      if(s>0) v.total = s;
    }
  }
  if(parsed.overall==null){
    parsed.overall = Object.values(parsed.filials||{}).reduce((a,b)=>a+(+b.total||0),0);
  }
}
function unionStatuses(d1, d2){
  const s = new Set();
  for(const f of Object.values(d1.filials||{})) Object.keys(f.statuses||{}).forEach(x=>s.add(x));
  for(const f of Object.values(d2.filials||{})) Object.keys(f.statuses||{}).forEach(x=>s.add(x));
  const ordered = CANON_STATUSES.filter(x=>s.has(x));
  for(const x of s) if(!ordered.includes(x)) ordered.push(x);
  return ordered;
}
function filialRegex(f){
  return new RegExp("^" + f.replace(/[-.*+?^${}()|[\]\\]/g,'\\$&') + "\\b");
}
function canonStatus(line){
  if(/–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ/i.test(line) && /—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ/i.test(line)) return CANON_STATUSES[0];
  if(/–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞/i.test(line)) return CANON_STATUSES[1];
  if(/–î–µ–º–æ–Ω/i.test(line)) return CANON_STATUSES[2];
  if(/–Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏/i.test(line)) return CANON_STATUSES[3];
  if(/–Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏/i.test(line)) return CANON_STATUSES[4];
  if(/–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏/i.test(line)) return CANON_STATUSES[5];
  return null;
}

async function extractDate(pdf){
  // –¥–∞—Ç–∞ ¬´–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ dd.mm.yyyy¬ª –æ–±—ã—á–Ω–æ –Ω–∞ —Å—Ç—Ä.1
  try{
    const lines = await getLinesFromPage(pdf, 1);
    for(const line of lines){
      const m = line.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
  }catch(e){ log(`–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É —Å–æ —Å—Ç—Ä.1: ${e.message||e}`, "warn"); }
  return null;
}

async function parseFilialsOnPage(pdf, pageNum){
  const lines = await getLinesFromPage(pdf, pageNum);
  const data = {};
  let current = null;

  for(const raw of lines){
    const line = normStr(raw);
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–ª–∏–∞–ª
    const f = FILIALS.find(name => filialRegex(name).test(line));
    if(f){
      const total = toIntSmart(line);
      data[f] = data[f] || { total: null, statuses:{} };
      if(!isNaN(total)) data[f].total = total;
      current = f;
      continue;
    }
    // –°—Ç–∞—Ç—É—Å –ø–æ–¥ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª–∏–∞–ª–æ–º
    if(current){
      const st = canonStatus(line);
      if(st){
        const v = toIntSmart(line);
        if(!isNaN(v)) data[current].statuses[st] = v;
        continue;
      }
    }
  }

  // ¬´–û–±—â–∏–π –∏—Ç–æ–≥¬ª
  let overall = null;
  const totalLine = lines.find(l=>/–û–±—â–∏–π –∏—Ç–æ–≥/i.test(l));
  if(totalLine) overall = toIntSmart(totalLine);

  const parsed = { filials: data, overall };
  ensureTotalsIfMissing(parsed);
  return parsed;
}

async function parseOne(file, label, baseProgress){
  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1 (–¥–∞—Ç–∞)`); setBar(baseProgress+5);
  const { pdf, usedWorker } = await loadPdfWithFallback(file, label);
  log(`${label}: —Ä–µ–∂–∏–º = ${usedWorker ? "worker" : "disableWorker"}`);

  const meta = { date: await extractDate(pdf) };

  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 2`); setBar(baseProgress+25);
  const p2 = await parseFilialsOnPage(pdf, 2);

  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 3`); setBar(baseProgress+50);
  const p3 = await parseFilialsOnPage(pdf, 3);

  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 4`); setBar(baseProgress+75);
  const p4 = await parseFilialsOnPage(pdf, 4);

  setBar(baseProgress+90);
  return { meta, p2, p3, p4 };
}

/* ============================== –†–ï–ù–î–ï–† ============================== */
let CURRENT=null, PREV=null;
let P2_CHART=null, P3_CHART=null, P4_CHART=null;

function renderKpi(){
  const kpi = $("#kpi"); kpi.innerHTML = "";
  if(!CURRENT || !PREV) return;
  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall;
  const revealed = (p2c!=null && p2p!=null) ? (p2c - p2p) : null;

  const rtC = CURRENT.p4.overall, rtP = PREV.p4.overall;
  const rtDelta = (rtC!=null && rtP!=null) ? (rtC - rtP) : null;

  $("#report-dates").textContent = `–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date || "‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date || "‚Äî"}`;

  kpi.innerHTML = `
    <div class="tile"><h3>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç (—Å—Ç—Ä.2, –û–±—â–∏–π –∏—Ç–æ–≥)</h3>
      <div class="v">${nfmt(p2c)}</div>
      <div class="small muted">–ü—Ä–µ–¥.: ${nfmt(p2p)} ¬∑ –ò–∑–º.: ${deltaFmt(revealed)}</div>
    </div>
    <div class="tile"><h3>¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <div class="v">${nfmt(revealed)}</div>
      <div class="small muted">–†–∞—Å—á—ë—Ç: —Ç–µ–∫—É—â–∏–π ‚àí –ø—Ä–µ–¥—ã–¥—É—â–∏–π</div>
    </div>
    <div class="tile"><h3>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª, –≤—Å–µ–≥–æ (—Å—Ç—Ä.4, –û–±—â–∏–π –∏—Ç–æ–≥)</h3>
      <div class="v">${nfmt(rtC)}</div>
      <div class="small muted">–ü—Ä–µ–¥.: ${nfmt(rtP)} ¬∑ –ò–∑–º.: ${deltaFmt(rtDelta)}</div>
    </div>
  `;

  // –°–∞–Ω–∏—Ç–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –≤–∞—à–∏—Ö –¥–∞—Ç
  const isOurDates = CURRENT.meta.date==="15.08.2025" && PREV.meta.date==="08.08.2025";
  if(isOurDates){
    if(revealed!==31627) log(`–û–∂–∏–¥–∞–ª–æ—Å—å ¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª = 31 627, –ø–æ–ª—É—á–µ–Ω–æ ${revealed}`, "warn");
    if(rtDelta!==20633)  log(`–û–∂–∏–¥–∞–ª–æ—Å—å ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º Œî¬ª = 20 633, –ø–æ–ª—É—á–µ–Ω–æ ${rtDelta}`, "warn");
    if(revealed===31627 && rtDelta===20633) log("–°–∞–Ω–∏—Ç–∏-—á–µ–∫ –ø—Ä–æ–π–¥–µ–Ω: ¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª=31 627 –∏ –†–æ—Å—Ç–µ–ª–µ–∫–æ–º Œî=20 633");
  }
}

function renderSection(targetId, curr, prev, chartId, chartTitle){
  const statuses = unionStatuses(curr, prev);
  const rows = FILIALS.map(f=>{
    const c = curr.filials[f] || { total:null, statuses:{} };
    const p = prev.filials[f] || { total:null, statuses:{} };
    const d = (c.total!=null && p.total!=null) ? (c.total - p.total) : null;
    return { f, c:c.total, p:p.total, d };
  });

  const totalC = rows.reduce((a,r)=>a+(+r.c||0),0);
  const totalP = rows.reduce((a,r)=>a+(+r.p||0),0);
  const totalD = totalC - totalP;

  let html = `<div class="fit"><table><thead>
    <tr><th>–§–∏–ª–∏–∞–ª</th><th>–¢–µ–∫—É—â–∏–π</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∏–π</th><th>–ò–∑–º.</th></tr>
  </thead><tbody>`;
  rows.forEach(r=>{
    const badge = r.d==null? "" : (r.d>0? '<span class="badge ok">‚Üë</span>' : r.d<0? '<span class="badge bad">‚Üì</span>' : '<span class="badge warn">0</span>');
    html += `<tr><td>${r.f}</td><td>${nfmt(r.c)}</td><td>${nfmt(r.p)}</td><td>${deltaFmt(r.d)} ${badge}</td></tr>`;
  });
  html += `</tbody><tfoot><tr><td>–ò–¢–û–ì–û –ø–æ –æ–±—â–µ—Å—Ç–≤—É</td><td>${nfmt(totalC)}</td><td>${nfmt(totalP)}</td><td>${deltaFmt(totalD)}</td></tr></tfoot></table></div>`;

  html += `<div class="hr"></div><div class="fit"><table><thead>
    <tr><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–∫—É—â–∏–π</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∏–π</th><th>–ò–∑–º.</th></tr>
  </thead><tbody>`;
  statuses.forEach(st=>{
    const c = Object.values(curr.filials).reduce((a,v)=>a+(+v.statuses[st]||0),0);
    const p = Object.values(prev.filials).reduce((a,v)=>a+(+v.statuses[st]||0),0);
    html += `<tr><td>${st}</td><td>${nfmt(c)}</td><td>${nfmt(p)}</td><td>${deltaFmt(c-p)}</td></tr>`;
  });
  html += `</tbody></table></div>`;

  document.getElementById(targetId).innerHTML = html;

  // –ì—Ä–∞—Ñ–∏–∫
  const labels = rows.map(r=>r.f);
  const deltas = rows.map(r=>r.d ?? 0);
  const currs  = rows.map(r=>r.c ?? 0);
  const prevs  = rows.map(r=>r.p ?? 0);

  if(chartId==="p2Chart" && P2_CHART) P2_CHART.destroy();
  if(chartId==="p3Chart" && P3_CHART) P3_CHART.destroy();
  if(chartId==="p4Chart" && P4_CHART) P4_CHART.destroy();

  const chart = new Chart(document.getElementById(chartId), {
    type:'bar',
    data:{ labels, datasets:[
      {label:'–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫—É—â–∏–π ‚àí –ø—Ä–µ–¥—ã–¥—É—â–∏–π)', data:deltas},
      {label:'–¢–µ–∫—É—â–∏–π', data:currs},
      {label:'–ü—Ä–µ–¥—ã–¥—É—â–∏–π', data:prevs},
    ]},
    options:{ responsive:true, plugins:{legend:{position:'bottom'}, title:{display:true, text:chartTitle}}, scales:{y:{beginAtZero:true}} }
  });
  if(chartId==="p2Chart") P2_CHART = chart;
  if(chartId==="p3Chart") P3_CHART = chart;
  if(chartId==="p4Chart") P4_CHART = chart;
}

/* ============================== –í–´–ì–†–£–ó–ö–ò ============================== */
function yymmddRus(d){ return d?.replaceAll(".","-") || "–¥–∞—Ç–∞"; }

async function downloadPptx(){
  if(!CURRENT || !PREV) return;
  const pptx = new PptxGenJS();
  const dateC = CURRENT.meta.date, dateP = PREV.meta.date;

  let slide = pptx.addSlide();
  slide.background = { color: '0033A0' };
  slide.addText("–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª", { x:0.5, y:0.4, fontSize:18, color:'FFFFFF', bold:true });
  slide.addText("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º –ø–æ–¥–≤–µ—Å–µ –í–û–õ–°", { x:0.5, y:1.0, fontSize:28, color:'FFFFFF', bold:true });
  slide.addText(`–¢–µ–∫—É—â–∏–π: ${dateC || "‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${dateP || "‚Äî"}`, { x:0.5, y:1.6, fontSize:16, color:'E3ECFF' });

  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;
  slide = pptx.addSlide();
  slide.addText("–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É", {x:0.5,y:0.5,fontSize:22,bold:true,color:'0033A0'});
  slide.addText(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${p2c?.toLocaleString('ru-RU')||"‚Äî"} (–ø—Ä–µ–¥.: ${p2p?.toLocaleString('ru-RU')||"‚Äî"})`, {x:0.5,y:1.1,fontSize:16});
  slide.addText(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${revealed?.toLocaleString('ru-RU')||"‚Äî"}`, {x:0.5,y:1.6,fontSize:16});

  async function addChartSlide(title, canvasId){
    const b64 = document.getElementById(canvasId).toDataURL("image/png");
    const slide = pptx.addSlide();
    slide.addText(title, {x:0.5,y:0.5,fontSize:22,bold:true,color:'0033A0'});
    slide.addImage({ data: b64, x:0.5, y:1.1, w:9.0, h:4.6 });
  }
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2", "p2Chart");
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425", "p3Chart");
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "p4Chart");

  await pptx.writeFile({ fileName: `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${yymmddRus(dateC)}.pptx` });
}
async function downloadPptPdf(){
  if(!CURRENT || !PREV) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const dateC = CURRENT.meta.date, dateP = PREV.meta.date;

  function title(){
    doc.setFillColor("#0033A0"); doc.rect(0,0,595,842,"F");
    doc.setTextColor("#FFFFFF"); doc.setFont("helvetica","bold"); doc.setFontSize(18);
    doc.text("–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª", 40, 60);
    doc.setFontSize(26); doc.text("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º –ø–æ–¥–≤–µ—Å–µ –í–û–õ–°", 40, 110);
    doc.setFontSize(14); doc.text(`–¢–µ–∫—É—â–∏–π: ${dateC||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${dateP||"‚Äî"}`, 40, 150);
  }
  function summary(){
    doc.addPage(); doc.setTextColor("#0033A0"); doc.setFont("helvetica","bold"); doc.setFontSize(20);
    doc.text("–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É", 40, 50);
    doc.setTextColor("#000"); doc.setFont("helvetica","normal"); doc.setFontSize(12);
    const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;
    doc.text(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${p2c?.toLocaleString('ru-RU')||"‚Äî"} (–ø—Ä–µ–¥.: ${p2p?.toLocaleString('ru-RU')||"‚Äî"})`, 40, 90);
    doc.text(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${revealed?.toLocaleString('ru-RU')||"‚Äî"}`, 40, 110);
  }
  async function addChart(title, canvasId){
    doc.addPage();
    doc.setTextColor("#0033A0"); doc.setFont("helvetica","bold"); doc.setFontSize(16);
    doc.text(title, 40, 50);
    const img = document.getElementById(canvasId).toDataURL("image/png");
    doc.addImage(img, "PNG", 40, 70, 515, 300);
  }

  title(); summary();
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –°—Ç—Ä.2", "p2Chart");
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425", "p3Chart");
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "p4Chart");
  doc.save(`–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${yymmddRus(dateC)}.pdf`);
}
async function downloadDocx(){
  if(!CURRENT || !PREV) return;
  const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, Packer } = docx;
  const p2Rows = FILIALS.map(f=>{
    const c = CURRENT.p2.filials[f]?.total ?? null;
    const p = PREV.p2.filials[f]?.total ?? null;
    const d = (c!=null && p!=null) ? (c - p) : null;
    return {f,c,p,d};
  });

  const head = new TableRow({
    children:[
      new TableCell({children:[new Paragraph({text:"–§–∏–ª–∏–∞–ª", bold:true})]}),
      new TableCell({children:[new Paragraph({text:"–¢–µ–∫—É—â–∏–π", bold:true})]}),
      new TableCell({children:[new Paragraph({text:"–ü—Ä–µ–¥—ã–¥—É—â–∏–π", bold:true})]}),
      new TableCell({children:[new Paragraph({text:"–ò–∑–º.", bold:true})]}),
    ]
  });
  const rows = p2Rows.map(r=>new TableRow({
    children:[
      new TableCell({children:[new Paragraph(r.f)]}),
      new TableCell({children:[new Paragraph(nfmt(r.c))]}),
      new TableCell({children:[new Paragraph(nfmt(r.p))]}),
      new TableCell({children:[new Paragraph((r.d>0?"+":"") + (r.d?.toLocaleString('ru-RU') ?? "‚Äî"))]}),
    ]
  }));
  const table = new Table({ rows:[head, ...rows], width:{size:100, type:WidthType.PERCENTAGE} });

  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;

  const docxFile = new Document({
    sections:[{ properties:{}, children:[
      new Paragraph({alignment:AlignmentType.LEFT, children:[ new TextRun({text:"–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª", bold:true, size:28}) ]}),
      new Paragraph({text:"–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º—É –ø–æ–¥–≤–µ—Å—É –í–û–õ–°", spacing:{after:120}}),
      new Paragraph({text:`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`, spacing:{after:180}}),
      new Paragraph({text:"–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É", bold:true}),
      new Paragraph({text:`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${nfmt(p2c)} (–ø—Ä–µ–¥.: ${nfmt(p2p)})`}),
      new Paragraph({text:`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${nfmt(revealed)}`, spacing:{after:180}}),
      new Paragraph({text:"–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (—Å—Ç—Ä.2 ‚Äî –í—Å–µ–≥–æ)", bold:true}),
      table,
      new Paragraph({text:"–ö—Ä–∞—Ç–∫–∏–µ –≤—ã–≤–æ–¥—ã:", bold:true, spacing:{before:200}}),
      new Paragraph({text:"1) –†–æ—Å—Ç/—Å–Ω–∏–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ –æ—Ç—Ä–∞–∂—ë–Ω –≤ –∫–æ–ª–æ–Ω–∫–µ ¬´–ò–∑–º.¬ª."}),
      new Paragraph({text:"2) –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º ‚Äî –Ω–∞ —Å–∞–π—Ç–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö."}),
    ]}]
  });

  const blob = await Packer.toBlob(docxFile);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `–°–ø—Ä–∞–≤–∫–∞_–í–û–õ–°_${yymmddRus(CURRENT.meta.date)}.docx`;
  a.click();
}
async function downloadDocPdf(){
  if(!CURRENT || !PREV) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;

  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor("#0033A0");
  doc.text("–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º—É –ø–æ–¥–≤–µ—Å—É –í–û–õ–°", 40, 50);
  doc.setFont("helvetica","normal"); doc.setTextColor("#000");
  doc.text(`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`, 40, 75);
  doc.text(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${nfmt(p2c)} (–ø—Ä–µ–¥.: ${nfmt(p2p)})`, 40, 100);
  doc.text(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${nfmt(revealed)}`, 40, 120);

  const top = FILIALS.map(f=>{
    const c = CURRENT.p2.filials[f]?.total ?? null;
    const p = PREV.p2.filials[f]?.total ?? null;
    const d = (c!=null && p!=null) ? (c - p) : null;
    return {f,c,p,d};
  }).filter(x=>x.d!=null).sort((a,b)=>Math.abs(b.d)-Math.abs(a.d)).slice(0,5);

  let y = 160;
  doc.setFont("helvetica","bold"); doc.text("–¢–æ–ø-5 –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å—Ç—Ä.2 ‚Äî –í—Å–µ–≥–æ)", 40, y);
  y+=20; doc.setFont("helvetica","normal");
  doc.text("–§–∏–ª–∏–∞–ª                –¢–µ–∫—É—â–∏–π    –ü—Ä–µ–¥.    –ò–∑–º.", 40, y); y+=14;
  top.forEach(r=>{
    const line = `${r.f.padEnd(22," ")} ${nfmt(r.c).padStart(8," ")}  ${nfmt(r.p).padStart(8," ")}  ${(r.d>0?"+":"")+(r.d?.toLocaleString('ru-RU')??"‚Äî")}`;
    doc.text(line, 40, y); y+=14;
  });

  doc.save(`–°–ø—Ä–∞–≤–∫–∞_–í–û–õ–°_${yymmddRus(CURRENT.meta.date)}.pdf`);
}

/* ============================== UI –õ–û–ì–ò–ö–ê ============================== */
const fileC = $("#fileCurrent");
const fileP = $("#filePrev");
[fileC, fileP].forEach(inp=>inp.addEventListener("change", ()=>{
  $("#btnParse").disabled = !(fileC.files[0] && fileP.files[0]);
  $("#parseStatus").textContent = "";
  setStatus(fileC.files[0] && fileP.files[0] ? "–ì–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É" : "–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤‚Ä¶");
}));

$("#btnParse").addEventListener("click", async ()=>{
  const fC = fileC.files[0], fP = fileP.files[0];
  if(!fC || !fP) return;

  $("#btnParse").disabled = true;
  $("#parseStatus").textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF‚Ä¶";
  $("#log").textContent = ""; // –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
  setBar(0); setStatus("–°—Ç–∞—Ä—Ç –∞–Ω–∞–ª–∏–∑–∞");

  try{
    setBar(2); log("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞");
    const cur = await parseOne(fC, "–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç", 0);
    setBar(45); log("–¢–µ–∫—É—â–∏–π ‚Äî –≥–æ—Ç–æ–≤");

    setBar(47); log("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞");
    const prev = await parseOne(fP, "–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç", 50);
    setBar(90); log("–ü—Ä–µ–¥—ã–¥—É—â–∏–π ‚Äî –≥–æ—Ç–æ–≤");

    CURRENT = cur; PREV = prev;

    // –†–µ–Ω–¥–µ—Ä
    log("–†–µ–Ω–¥–µ—Ä KPI –∏ —Ç–∞–±–ª–∏—Ü‚Ä¶");
    renderKpi();

    const rows2 = renderSection("p2Tables", CURRENT.p2, PREV.p2, "p2Chart", "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");
    const rows3 = renderSection("p3Tables", CURRENT.p3, PREV.p3, "p3Chart", "–ü—Ä–∏–∫–∞–∑ ‚Ññ425 ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");
    const rows4 = renderSection("p4Tables", CURRENT.p4, PREV.p4, "p4Chart", "–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");

    setBar(100); setStatus("–ì–æ—Ç–æ–≤–æ");
    $("#parseStatus").textContent = "–ì–æ—Ç–æ–≤–æ.";
    log("–ì–æ—Ç–æ–≤–æ. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî —Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤—ã—à–µ.");
  }catch(e){
    log(`–ê–Ω–∞–ª–∏–∑ –ø—Ä–µ—Ä–≤–∞–Ω: ${e && e.message || e}`, "error");
    $("#parseStatus").textContent = "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞. –°–º. –ª–æ–≥ –Ω–∏–∂–µ.";
    setStatus("–û—à–∏–±–∫–∞");
  }finally{
    $("#btnParse").disabled = false;
  }
});

/* ============================== –ö–ù–û–ü–ö–ò –í–´–ì–†–£–ó–û–ö ============================== */
$("#dlPptx").addEventListener("click", downloadPptx);
$("#dlPptPdf").addEventListener("click", downloadPptPdf);
$("#dlDocx").addEventListener("click", downloadDocx);
$("#dlDocPdf").addEventListener("click", downloadDocPdf);
</script>
</body>
</html>
