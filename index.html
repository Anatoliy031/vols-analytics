<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --rs-blue:#0033A0; --rs-blue-2:#0A47C6; --rs-bg:#F5F7FB; --rs-text:#101828;
      --rs-muted:#667085; --border:#E5E7EB; --ok:#2E7D32; --bad:#C62828; --warn:#ED6C02;
      --card:#fff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--rs-bg);color:var(--rs-text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{background:linear-gradient(90deg,var(--rs-blue),var(--rs-blue-2));color:#fff;padding:16px;position:sticky;top:0;z-index:50;box-shadow:0 2px 12px rgba(0,0,0,.12)}
    .wrap{max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:50%;background:#fff;display:grid;place-items:center;color:var(--rs-blue);font-weight:900}
    h1{font-size:20px;margin:0}
    main{padding:18px 16px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){ .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    .card h2{margin:0 0 10px;font-size:18px}
    .muted{color:var(--rs-muted)} .small{font-size:12px}
    .u-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--rs-blue);color:#fff}
    .btn.secondary{background:#fff;color:var(--rs-blue);border:1px solid var(--rs-blue)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type=file]{padding:10px;background:#fff;border:1px dashed var(--border);border-radius:12px;width:100%}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .tile{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}
    .tile h3{margin:0 0 6px;font-size:14px;color:var(--rs-muted)}
    .tile .v{font-size:22px;font-weight:800}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{position:sticky;top:0;background:#F2F6FF;border-bottom:2px solid var(--border)}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child,td:first-child{text-align:left}
    tfoot td{font-weight:800;background:#FAFAFC}
    .delta.pos{color:#2E7D32}.delta.neg{color:#C62828}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#E8F5E9;color:#2E7D32}.warn{background:#FFF3E0;color:#ED6C02}.bad{background:#FFEBEE;color:#C62828}
    .fit{width:100%;overflow:auto}
    canvas{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    .footer-actions{display:flex;flex-wrap:wrap;gap:10px}
    .hr{height:1px;background:var(--border);margin:10px 0 16px}

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å + –ª–æ–≥ */
    .progress{display:flex;align-items:center;gap:12px}
    .bar{flex:1;background:#E9EFFD;border-radius:999px;height:10px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#69A1FF,#0033A0)}
    .status{min-width:250px;font-size:12px;color:#123}
    .log{background:#0E1116;color:#D6E2FF;border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:220px;overflow:auto;border:1px solid #1E2633}
    .log .err{color:#FFB4B4}.log .warn{color:#FFD28A}
    .sticky-controls{position:sticky;bottom:12px;z-index:40}
  </style>

  <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥—Ä—É–∑–∏–º –æ–±—ã—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap u-row">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <div>
          <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</h1>
          <div class="small" id="report-dates">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á—ë—Ç—ã (—Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π)</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2>1) –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ (PDF)</h2>
      <p class="muted small">–ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>—Ç–µ–∫—É—â–∏–π</b> –∏ <b>–ø—Ä–µ–¥—ã–¥—É—â–∏–π</b> –æ—Ç—á—ë—Ç—ã (—Å—Ç—Ä. 2‚Äì4). –ï—Å—Ç—å –ª–æ–≥, –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∞–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∞ pdf.js —Å 3 CDN.</p>
      <div class="grid grid-2">
        <div>
          <label class="small">–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.08.2025)</label>
          <input type="file" id="fileCurrent" accept="application/pdf" />
        </div>
        <div>
          <label class="small">–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 08.08.2025)</label>
          <input type="file" id="filePrev" accept="application/pdf" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="progress">
        <div class="bar"><span id="bar"></span></div>
        <div class="status" id="status">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤‚Ä¶</div>
      </div>
      <div class="hr"></div>

      <div class="u-row sticky-controls">
        <button class="btn" id="btnParse" disabled>üîé –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        <span class="small muted" id="parseStatus"></span>
      </div>

      <div class="hr"></div>
      <div class="log" id="log"></div>
    </section>

    <section class="card">
      <h2>2) –ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É</h2>
      <div class="kpi" id="kpi"></div>
      <p class="small muted">¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª = —Ä–∞–∑–Ω–∏—Ü–∞ ¬´–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç¬ª (—Å—Ç—Ä. 2, ¬´–û–±—â–∏–π –∏—Ç–æ–≥¬ª) —Ç–µ–∫—É—â–∏–π ‚àí –ø—Ä–µ–¥—ã–¥—É—â–∏–π.</p>
    </section>

    <section class="card">
      <h2>3) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –°—Ç–∞–¥–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h2>
      <div id="p2Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p2Chart" height="120"></canvas>
    </section>

    <section class="card">
      <h2>4) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425</h2>
      <div id="p3Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p3Chart" height="120"></canvas>
    </section>

    <section class="card">
      <h2>5) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
      <div id="p4Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p4Chart" height="120"></canvas>
    </section>

    <section class="card">
      <h2>6) –í—ã–≥—Ä—É–∑–∫–∏</h2>
      <div class="footer-actions">
        <button class="btn" id="dlPptx">üìä –°–∫–∞—á–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é PPTX</button>
        <button class="btn secondary" id="dlPptPdf">üìä –°–∫–∞—á–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é PDF</button>
        <button class="btn" id="dlDocx">üìë –°–∫–∞—á–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É Word</button>
        <button class="btn secondary" id="dlDocPdf">üìë –°–∫–∞—á–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É PDF</button>
      </div>
    </section>
  </main>

<script>
/* ================== –õ–û–ì/–°–¢–ê–¢–£–°/–ü–†–û–ì–†–ï–°–° ================== */
const $ = s => document.querySelector(s);
function log(msg, type="info"){
  const el = $("#log");
  const time = new Date().toLocaleTimeString('ru-RU');
  const line = document.createElement("div");
  if(type==="error") line.classList.add("err");
  if(type==="warn")  line.classList.add("warn");
  line.textContent = `[${time}] ${msg}`;
  el.appendChild(line); el.scrollTop = el.scrollHeight;
  console[type==="error"?"error":type==="warn"?"warn":"log"](msg);
}
function setStatus(text){ $("#status").textContent = text; }
function setBar(p){ $("#bar").style.width = Math.max(0, Math.min(100, p)) + "%"; }
window.onerror = (m,s,l,c,e)=>log(`JS Error: ${m} at ${s}:${l}:${c}`,"error");
window.onunhandledrejection = e=>log(`Unhandled Rejection: ${e.reason?.message||e.reason||e}`,"error");

/* ============== –î–ò–ù. –ó–ê–ì–†–£–ó–ö–ê pdf.js –° –ù–ï–°–ö–û–õ–¨–ö–ò–• CDN ============== */
const PDFJS_URLS = [
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js",
  "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.3.136/build/pdf.min.js",
  "https://unpkg.com/pdfjs-dist@4.3.136/build/pdf.min.js"
];
const PDFJS_WORKER_URLS = [
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js",
  "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.3.136/build/pdf.worker.min.js",
  "https://unpkg.com/pdfjs-dist@4.3.136/build/pdf.worker.min.js"
];

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s = document.createElement("script");
    s.src = src; s.async = true; s.onload = resolve; s.onerror = ()=>reject(new Error(`Load failed: ${src}`));
    document.head.appendChild(s);
  });
}

async function ensurePdfJs(){
  for(let i=0;i<PDFJS_URLS.length;i++){
    try{
      if(!window.pdfjsLib){ log(`–ü—Ä–æ–±—É—é –∑–∞–≥—Ä—É–∑–∏—Ç—å pdf.js: ${PDFJS_URLS[i]}`); await loadScript(PDFJS_URLS[i]); }
      if(window.pdfjsLib){
        const worker = PDFJS_WORKER_URLS[i] || PDFJS_WORKER_URLS[0];
        pdfjsLib.GlobalWorkerOptions.workerSrc = worker;
        log(`pdf.js –∑–∞–≥—Ä—É–∂–µ–Ω (${PDFJS_URLS[i].split('/')[2]}), worker: ${worker.split('/')[2]}`);
        return true;
      }
    }catch(err){
      log(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å pdf.js c ${PDFJS_URLS[i]} ‚Äî ${err.message}`,"warn");
    }
  }
  log("pdfjsLib –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ CDN.", "error");
  return false;
}

/* ============== –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã/–ø–∞—Ä—Å–µ—Ä (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) ============== */
const FILIALS = [
  "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
  "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°",
];
const CANON_STATUSES = [
  "–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
  "–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞",
  "–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ",
];

function normStr(s){ if(!s)return ""; return String(s).replace(/\u00A0/g," ").replace(/[‚Äê‚Äì‚Äî‚àí]/g,"-").replace(/\s+/g," ").trim(); }
function nfmt(v){ return (v==null || isNaN(v)) ? "‚Äî" : v.toLocaleString('ru-RU'); }
function deltaFmt(v){ if(v==null||isNaN(v))return "‚Äî"; const cls=v>0?"pos":v<0?"neg":""; const sign=v>0?"+":""; return `<span class="delta ${cls}">${sign}${v.toLocaleString('ru-RU')}</span>`; }
function toIntSmart(s){ if(s==null)return null; const m=String(s).replace(/\u00A0/g," ").match(/-?\d[\d\s]*\d|\d/); if(!m)return null; return parseInt(m[0].replace(/\s+/g,""),10); }
function safeXY(item){ const t=item&&item.transform; return {x:(t&&typeof t[4]==="number")?t[4]:0, y:(t&&typeof t[5]==="number")?t[5]:0}; }

async function loadPdfWithFallback(file,label){
  const ab = await file.arrayBuffer();
  // 1) worker
  try{
    setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${label}: worker‚Ä¶`); log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${label} (worker)`);
    const task = pdfjsLib.getDocument({ data: ab });
    const pdf = await task.promise;
    log(`${label}: –∑–∞–≥—Ä—É–∂–µ–Ω (worker)`); return { pdf, usedWorker:true };
  }catch(e1){
    log(`${label}: worker –æ—à–∏–±–∫–∞ (${e1.message}). –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ disableWorker‚Ä¶`,"warn");
    const task2 = pdfjsLib.getDocument({ data: ab, disableWorker:true });
    const pdf2 = await task2.promise;
    log(`${label}: –∑–∞–≥—Ä—É–∂–µ–Ω (disableWorker)`); return { pdf: pdf2, usedWorker:false };
  }
}

async function getLinesFromPage(pdf, pageNum){
  const page = await pdf.getPage(pageNum);
  const text = await page.getTextContent();
  const items = text?.items || [];
  const sorted = items.slice().sort((a,b)=>{
    const A=safeXY(a), B=safeXY(b);
    if(Math.abs(B.y-A.y)>0.1) return B.y-A.y;
    return A.x-B.x;
  });
  const rows=[]; const Y_TOL=2;
  for(const it of sorted){
    const {x,y}=safeXY(it); const s=normStr(it.str); if(!s) continue;
    let row = rows.find(r=>Math.abs(r.y-y)<=Y_TOL); if(!row){row={y,parts:[]}; rows.push(row);}
    row.parts.push({x,s});
  }
  return rows.map(r=>normStr(r.parts.sort((a,b)=>a.x-b.x).map(p=>p.s).join(" "))).filter(Boolean);
}

function ensureTotalsIfMissing(parsed){
  for(const [k,v] of Object.entries(parsed.filials||{})){
    if(v.total==null){ const s=Object.values(v.statuses||{}).reduce((a,b)=>a+(+b||0),0); if(s>0) v.total=s; }
  }
  if(parsed.overall==null){ parsed.overall = Object.values(parsed.filials||{}).reduce((a,b)=>a+(+b.total||0),0); }
}
function unionStatuses(d1,d2){
  const s=new Set();
  for(const f of Object.values(d1.filials||{})) Object.keys(f.statuses||{}).forEach(x=>s.add(x));
  for(const f of Object.values(d2.filials||{})) Object.keys(f.statuses||{}).forEach(x=>s.add(x));
  const ordered = CANON_STATUSES.filter(x=>s.has(x)); for(const x of s) if(!ordered.includes(x)) ordered.push(x); return ordered;
}
function filialRegex(f){ return new RegExp("^"+f.replace(/[-.*+?^${}()|[\]\\]/g,"\\$&")+"\\b"); }
function canonStatus(line){
  if(/–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ/i.test(line)&&/—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ/i.test(line)) return CANON_STATUSES[0];
  if(/–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞/i.test(line)) return CANON_STATUSES[1];
  if(/–î–µ–º–æ–Ω/i.test(line)) return CANON_STATUSES[2];
  if(/–Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏/i.test(line)) return CANON_STATUSES[3];
  if(/–Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏/i.test(line)) return CANON_STATUSES[4];
  if(/–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏/i.test(line)) return CANON_STATUSES[5];
  return null;
}

async function extractDate(pdf){
  try{
    const lines = await getLinesFromPage(pdf,1);
    for(const line of lines){ const m=line.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i); if(m) return m[1]; }
  }catch(e){ log(`–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É —Å–æ —Å—Ç—Ä.1: ${e.message}`,"warn"); }
  return null;
}
async function parseFilialsOnPage(pdf,pageNum){
  const lines = await getLinesFromPage(pdf,pageNum);
  const data={}; let current=null;
  for(const raw of lines){
    const line=normStr(raw);
    const f = FILIALS.find(name=>filialRegex(name).test(line));
    if(f){ const total=toIntSmart(line); data[f]=data[f]||{total:null,statuses:{}}; if(!isNaN(total)) data[f].total=total; current=f; continue; }
    if(current){ const st=canonStatus(line); if(st){ const v=toIntSmart(line); if(!isNaN(v)) data[current].statuses[st]=v; } }
  }
  let overall=null; const totalLine = lines.find(l=>/–û–±—â–∏–π –∏—Ç–æ–≥/i.test(l)); if(totalLine) overall=toIntSmart(totalLine);
  const parsed={filials:data,overall}; ensureTotalsIfMissing(parsed); return parsed;
}
async function parseOne(file,label,baseProgress){
  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä.1 (–¥–∞—Ç–∞)`); setBar(baseProgress+5);
  const { pdf, usedWorker } = await loadPdfWithFallback(file,label);
  log(`${label}: —Ä–µ–∂–∏–º = ${usedWorker?"worker":"disableWorker"}`);
  const meta = { date: await extractDate(pdf) };

  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 2`); setBar(baseProgress+25);
  const p2 = await parseFilialsOnPage(pdf,2);
  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 3`); setBar(baseProgress+50);
  const p3 = await parseFilialsOnPage(pdf,3);
  setStatus(`–ß—Ç–µ–Ω–∏–µ ${label}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 4`); setBar(baseProgress+75);
  const p4 = await parseFilialsOnPage(pdf,4);

  setBar(baseProgress+90);
  return { meta,p2,p3,p4 };
}

/* ================== –†–ï–ù–î–ï–†/–í–´–ì–†–£–ó–ö–ò (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) ================== */
let CURRENT=null, PREV=null;
let P2_CHART=null, P3_CHART=null, P4_CHART=null;

function renderKpi(){
  const kpi=$("#kpi"); kpi.innerHTML="";
  if(!CURRENT||!PREV) return;
  const p2c=CURRENT.p2.overall, p2p=PREV.p2.overall;
  const revealed=(p2c!=null&&p2p!=null)?(p2c-p2p):null;
  const rtC=CURRENT.p4.overall, rtP=PREV.p4.overall;
  const rtDelta=(rtC!=null&&rtP!=null)?(rtC-rtP):null;

  $("#report-dates").textContent=`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`;
  kpi.innerHTML=`
    <div class="tile"><h3>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç (—Å—Ç—Ä.2, –û–±—â–∏–π –∏—Ç–æ–≥)</h3><div class="v">${nfmt(p2c)}</div><div class="small muted">–ü—Ä–µ–¥.: ${nfmt(p2p)} ¬∑ –ò–∑–º.: ${deltaFmt(revealed)}</div></div>
    <div class="tile"><h3>¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é</h3><div class="v">${nfmt(revealed)}</div><div class="small muted">–†–∞—Å—á—ë—Ç: —Ç–µ–∫—É—â–∏–π ‚àí –ø—Ä–µ–¥—ã–¥—É—â–∏–π</div></div>
    <div class="tile"><h3>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª, –≤—Å–µ–≥–æ (—Å—Ç—Ä.4, –û–±—â–∏–π –∏—Ç–æ–≥)</h3><div class="v">${nfmt(rtC)}</div><div class="small muted">–ü—Ä–µ–¥.: ${nfmt(rtP)} ¬∑ –ò–∑–º.: ${deltaFmt(rtDelta)}</div></div>
  `;
  const isOurDates = CURRENT.meta.date==="15.08.2025" && PREV.meta.date==="08.08.2025";
  if(isOurDates){
    if(revealed!==31627) log(`–û–∂–∏–¥–∞–ª–æ—Å—å ¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª = 31 627, –ø–æ–ª—É—á–µ–Ω–æ ${revealed}`,"warn");
    if(rtDelta!==20633)  log(`–û–∂–∏–¥–∞–ª–æ—Å—å ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º Œî¬ª = 20 633, –ø–æ–ª—É—á–µ–Ω–æ ${rtDelta}`,"warn");
    if(revealed===31627 && rtDelta===20633) log("–°–∞–Ω–∏—Ç–∏-—á–µ–∫ –ø—Ä–æ–π–¥–µ–Ω: ¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª=31 627 –∏ –†–æ—Å—Ç–µ–ª–µ–∫–æ–º Œî=20 633");
  }
}
function renderSection(targetId,curr,prev,chartId,chartTitle){
  const statuses=unionStatuses(curr,prev);
  const labels=FILIALS;
  const rows=labels.map(f=>{
    const c=curr.filials[f]?.total??null;
    const p=prev.filials[f]?.total??null;
    const d=(c!=null&&p!=null)?(c-p):null;
    return {f,c,p,d};
  });

  const totalC=rows.reduce((a,r)=>a+(+r.c||0),0);
  const totalP=rows.reduce((a,r)=>a+(+r.p||0),0);
  const totalD=totalC-totalP;

  let html=`<div class="fit"><table><thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–¢–µ–∫—É—â–∏–π</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∏–π</th><th>–ò–∑–º.</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const badge = r.d==null? "" : (r.d>0? '<span class="badge ok">‚Üë</span>' : r.d<0? '<span class="badge bad">‚Üì</span>' : '<span class="badge warn">0</span>');
    html += `<tr><td>${r.f}</td><td>${nfmt(r.c)}</td><td>${nfmt(r.p)}</td><td>${deltaFmt(r.d)} ${badge}</td></tr>`;
  });
  html += `</tbody><tfoot><tr><td>–ò–¢–û–ì–û –ø–æ –æ–±—â–µ—Å—Ç–≤—É</td><td>${nfmt(totalC)}</td><td>${nfmt(totalP)}</td><td>${deltaFmt(totalD)}</td></tr></tfoot></table></div>`;

  html += `<div class="hr"></div><div class="fit"><table><thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–∫—É—â–∏–π</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∏–π</th><th>–ò–∑–º.</th></tr></thead><tbody>`;
  statuses.forEach(st=>{
    const c=Object.values(curr.filials).reduce((a,v)=>a+(+v.statuses[st]||0),0);
    const p=Object.values(prev.filials).reduce((a,v)=>a+(+v.statuses[st]||0),0);
    html += `<tr><td>${st}</td><td>${nfmt(c)}</td><td>${nfmt(p)}</td><td>${deltaFmt(c-p)}</td></tr>`;
  });
  html += `</tbody></table></div>`;
  document.getElementById(targetId).innerHTML=html;

  // –≥—Ä–∞—Ñ–∏–∫
  const deltas=rows.map(r=>r.d??0);
  const currs=rows.map(r=>r.c??0);
  const prevs=rows.map(r=>r.p??0);
  if(chartId==="p2Chart"&&window.P2_CHART) P2_CHART.destroy();
  if(chartId==="p3Chart"&&window.P3_CHART) P3_CHART.destroy();
  if(chartId==="p4Chart"&&window.P4_CHART) P4_CHART.destroy();
  const chart=new Chart(document.getElementById(chartId),{
    type:'bar',
    data:{labels:labels,datasets:[
      {label:'–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫—É—â–∏–π ‚àí –ø—Ä–µ–¥—ã–¥—É—â–∏–π)',data:deltas},
      {label:'–¢–µ–∫—É—â–∏–π',data:currs},
      {label:'–ü—Ä–µ–¥—ã–¥—É—â–∏–π',data:prevs}
    ]},
    options:{responsive:true,plugins:{legend:{position:'bottom'},title:{display:true,text:chartTitle}},scales:{y:{beginAtZero:true}}}
  });
  if(chartId==="p2Chart") P2_CHART=chart;
  if(chartId==="p3Chart") P3_CHART=chart;
  if(chartId==="p4Chart") P4_CHART=chart;
}

/* ================== –í—ã–≥—Ä—É–∑–∫–∏ (pptx/pdf/docx) ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ ================== */
function yymmddRus(d){ return d?.replaceAll(".","-") || "–¥–∞—Ç–∞"; }
async function downloadPptx(){ if(!CURRENT||!PREV) return;
  const pptx=new PptxGenJS(); const dateC=CURRENT.meta.date, dateP=PREV.meta.date;
  let slide=pptx.addSlide(); slide.background={color:'0033A0'};
  slide.addText("–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª",{x:0.5,y:0.4,fontSize:18,color:'FFFFFF',bold:true});
  slide.addText("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º –ø–æ–¥–≤–µ—Å–µ –í–û–õ–°",{x:0.5,y:1.0,fontSize:28,color:'FFFFFF',bold:true});
  slide.addText(`–¢–µ–∫—É—â–∏–π: ${dateC||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${dateP||"‚Äî"}`,{x:0.5,y:1.6,fontSize:16,color:'E3ECFF'});
  const p2c=CURRENT.p2.overall, p2p=PREV.p2.overall, revealed=(p2c!=null&&p2p!=null)?(p2c-p2p):null;
  slide=pptx.addSlide();
  slide.addText("–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É",{x:0.5,y:0.5,fontSize:22,bold:true,color:'0033A0'});
  slide.addText(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${p2c?.toLocaleString('ru-RU')||"‚Äî"} (–ø—Ä–µ–¥.: ${p2p?.toLocaleString('ru-RU')||"‚Äî"})`,{x:0.5,y:1.1,fontSize:16});
  slide.addText(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${revealed?.toLocaleString('ru-RU')||"‚Äî"}`,{x:0.5,y:1.6,fontSize:16});
  async function addChartSlide(title,canvasId){
    const b64=document.getElementById(canvasId).toDataURL("image/png");
    const s=pptx.addSlide(); s.addText(title,{x:0.5,y:0.5,fontSize:22,bold:true,color:'0033A0'});
    s.addImage({data:b64,x:0.5,y:1.1,w:9.0,h:4.6});
  }
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2","p2Chart");
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425","p3Chart");
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª","p4Chart");
  await pptx.writeFile({fileName:`–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${yymmddRus(dateC)}.pptx`});
}
async function downloadPptPdf(){ if(!CURRENT||!PREV) return;
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:"pt",format:"a4"});
  const dateC=CURRENT.meta.date, dateP=PREV.meta.date;
  function title(){ doc.setFillColor("#0033A0"); doc.rect(0,0,595,842,"F");
    doc.setTextColor("#FFFFFF"); doc.setFont("helvetica","bold"); doc.setFontSize(18); doc.text("–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª",40,60);
    doc.setFontSize(26); doc.text("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º –ø–æ–¥–≤–µ—Å–µ –í–û–õ–°",40,110);
    doc.setFontSize(14); doc.text(`–¢–µ–∫—É—â–∏–π: ${dateC||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${dateP||"‚Äî"}`,40,150);
  }
  function summary(){ doc.addPage(); doc.setTextColor("#0033A0"); doc.setFont("helvetica","bold"); doc.setFontSize(20); doc.text("–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É",40,50);
    doc.setTextColor("#000"); doc.setFont("helvetica","normal"); doc.setFontSize(12);
    const p2c=CURRENT.p2.overall, p2p=PREV.p2.overall, revealed=(p2c!=null&&p2p!=null)?(p2c-p2p):null;
    doc.text(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${p2c?.toLocaleString('ru-RU')||"‚Äî"} (–ø—Ä–µ–¥.: ${p2p?.toLocaleString('ru-RU')||"‚Äî"})`,40,90);
    doc.text(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${revealed?.toLocaleString('ru-RU')||"‚Äî"}`,40,110);
  }
  async function addChart(title,canvasId){ doc.addPage(); doc.setTextColor("#0033A0"); doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.text(title,40,50);
    const img=document.getElementById(canvasId).toDataURL("image/png"); doc.addImage(img,"PNG",40,70,515,300);
  }
  title(); summary();
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –°—Ç—Ä.2","p2Chart");
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425","p3Chart");
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª","p4Chart");
  doc.save(`–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${yymmddRus(dateC)}.pdf`);
}
async function downloadDocx(){ if(!CURRENT||!PREV) return;
  const {Document,Paragraph,TextRun,Table,TableRow,TableCell,WidthType,AlignmentType,Packer}=docx;
  const rows=FILIALS.map(f=>{ const c=CURRENT.p2.filials[f]?.total??null; const p=PREV.p2.filials[f]?.total??null; const d=(c!=null&&p!=null)?(c-p):null; return {f,c,p,d};});
  const head=new TableRow({children:[
    new TableCell({children:[new Paragraph({text:"–§–∏–ª–∏–∞–ª",bold:true})]}),
    new TableCell({children:[new Paragraph({text:"–¢–µ–∫—É—â–∏–π",bold:true})]}),
    new TableCell({children:[new Paragraph({text:"–ü—Ä–µ–¥—ã–¥—É—â–∏–π",bold:true})]}),
    new TableCell({children:[new Paragraph({text:"–ò–∑–º.",bold:true})]})
  ]});
  const body=rows.map(r=>new TableRow({children:[
    new TableCell({children:[new Paragraph(r.f)]}),
    new TableCell({children:[new Paragraph(nfmt(r.c))]}),
    new TableCell({children:[new Paragraph(nfmt(r.p))]}),
    new TableCell({children:[new Paragraph((r.d>0?"+":"")+(r.d?.toLocaleString('ru-RU')??"‚Äî"))]})
  ]}));
  const table=new Table({rows:[head,...body],width:{size:100,type:WidthType.PERCENTAGE}});
  const p2c=CURRENT.p2.overall, p2p=PREV.p2.overall, revealed=(p2c!=null&&p2p!=null)?(p2c-p2p):null;
  const docxFile=new Document({sections:[{properties:{},children:[
    new Paragraph({alignment:AlignmentType.LEFT,children:[new TextRun({text:"–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª",bold:true,size:28})]}),
    new Paragraph({text:"–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º—É –ø–æ–¥–≤–µ—Å—É –í–û–õ–°",spacing:{after:120}}),
    new Paragraph({text:`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`,spacing:{after:180}}),
    new Paragraph({text:"–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É",bold:true}),
    new Paragraph({text:`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${nfmt(p2c)} (–ø—Ä–µ–¥.: ${nfmt(p2p)})`}),
    new Paragraph({text:`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${nfmt(revealed)}`,spacing:{after:180}}),
    new Paragraph({text:"–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (—Å—Ç—Ä.2 ‚Äî –í—Å–µ–≥–æ)",bold:true}),
    table
  ]}]});
  const blob=await Packer.toBlob(docxFile); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download=`–°–ø—Ä–∞–≤–∫–∞_–í–û–õ–°_${yymmddRus(CURRENT.meta.date)}.docx`; a.click();
}
async function downloadDocPdf(){ if(!CURRENT||!PREV) return;
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:"pt",format:"a4"});
  const p2c=CURRENT.p2.overall, p2p=PREV.p2.overall, revealed=(p2c!=null&&p2p!=null)?(p2c-p2p):null;
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor("#0033A0"); doc.text("–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º—É –ø–æ–¥–≤–µ—Å—É –í–û–õ–°",40,50);
  doc.setFont("helvetica","normal"); doc.setTextColor("#000"); doc.text(`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`,40,75);
  doc.text(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${nfmt(p2c)} (–ø—Ä–µ–¥.: ${nfmt(p2p)})`,40,100); doc.text(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${nfmt(revealed)}`,40,120);
  doc.save(`–°–ø—Ä–∞–≤–∫–∞_–í–û–õ–°_${yymmddRus(CURRENT.meta.date)}.pdf`);
}

/* ================== UI: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ü–£–°–ö ================== */
const fileC=$("#fileCurrent"); const fileP=$("#filePrev");
[fileC,fileP].forEach(inp=>inp.addEventListener("change",()=>{
  $("#btnParse").disabled=!(fileC.files[0]&&fileP.files[0]);
  $("#parseStatus").textContent=""; setStatus(fileC.files[0]&&fileP.files[0]?"–ì–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É":"–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤‚Ä¶");
}));

$("#btnParse").addEventListener("click", async ()=>{
  $("#btnParse").disabled=true; $("#parseStatus").textContent="–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF‚Ä¶"; $("#log").textContent="";
  setBar(0); setStatus("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶");
  try{
    const ok = await ensurePdfJs();
    if(!ok){ $("#parseStatus").textContent="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å pdf.js (—Å–º. –ª–æ–≥)."; setStatus("–û—à–∏–±–∫–∞ pdf.js"); return; }

    setBar(2); log("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞");
    const cur = await parseOne(fileC.files[0],"–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç",0);
    setBar(45); log("–¢–µ–∫—É—â–∏–π ‚Äî –≥–æ—Ç–æ–≤");

    setBar(47); log("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞");
    const prev = await parseOne(fileP.files[0],"–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç",50);
    setBar(90); log("–ü—Ä–µ–¥—ã–¥—É—â–∏–π ‚Äî –≥–æ—Ç–æ–≤");

    CURRENT=cur; PREV=prev;

    log("–†–µ–Ω–¥–µ—Ä KPI –∏ —Ç–∞–±–ª–∏—Ü‚Ä¶");
    renderKpi();
    renderSection("p2Tables", CURRENT.p2, PREV.p2, "p2Chart", "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");
    renderSection("p3Tables", CURRENT.p3, PREV.p3, "p3Chart", "–ü—Ä–∏–∫–∞–∑ ‚Ññ425 ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");
    renderSection("p4Tables", CURRENT.p4, PREV.p4, "p4Chart", "–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");

    setBar(100); setStatus("–ì–æ—Ç–æ–≤–æ"); $("#parseStatus").textContent="–ì–æ—Ç–æ–≤–æ.";
  }catch(e){
    log(`–ê–Ω–∞–ª–∏–∑ –ø—Ä–µ—Ä–≤–∞–Ω: ${e.message||e}`,"error");
    $("#parseStatus").textContent="–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞. –°–º. –ª–æ–≥ –Ω–∏–∂–µ.";
    setStatus("–û—à–∏–±–∫–∞");
  }finally{
    $("#btnParse").disabled=false;
  }
});

/* ================== –ö–ù–û–ü–ö–ò –í–´–ì–†–£–ó–û–ö ================== */
$("#dlPptx").addEventListener("click", downloadPptx);
$("#dlPptPdf").addEventListener("click", downloadPptPdf);
$("#dlDocx").addEventListener("click", downloadDocx);
$("#dlDocPdf").addEventListener("click", downloadDocPdf);
</script>
</body>
</html>
